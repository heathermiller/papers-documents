\section{Proofs}

\subsection{Proof of Theorem~\ref{lem:ser-values}}\label{app:ser-values}

\begin{thmun}
\emph{(Serializable Values)}
If $\Gamma ; \Sigma \vdash v : T$ and $serializable(T)$ then $\emptyset ; \Sigma \vdash v : T$.
\end{thmun}
\begin{proof}
By induction on the derivation of $\Gamma ; \Sigma \vdash v : T$ with a case analysis on the last applied rule.

\begin{itemize}
\item Cases \textsc{T-Unit} and \textsc{T-Host} are trivial.

\item Case \textsc{T-SiloRef}.
\begin{enumerate}
% 1.
\item By the assumptions
  \begin{enumerate}[label=(\alph*)]
  \item $\Gamma ; \Sigma \vdash v : T$
  \item $serializable(T)$
  \end{enumerate}
% 2.
\item By 1.a) and \textsc{T-SiloRef}
  \begin{enumerate}[label=(\alph*)]
  \item $v = {\Ref l h}$
  \item $T = \SR{T'}$
  \item $\Sigma(id(l)) = T'$
  \item $\Sigma \vdash {\Ref l h}$
  \end{enumerate}
% 3.
\item By 2.a-d), and \textsc{T-SiloRef}, $\emptyset ; \Sigma \vdash v : T$.
\end{enumerate}

\item Case \textsc{T-Spore} follows by \textsc{S-Spore} and the IH.
\end{itemize}
\end{proof}


\subsection{Proof of Lemma~\ref{lem:queue-concat}}\label{app:queue-concat}

\begin{lemmaun}
\emph{(Queue Concatenation)}
If $\Sigma \vdash Q$ and $\Sigma \vdash Q'$ then $\Sigma \vdash Q ::: Q'$.
\end{lemmaun}
\begin{proof}
By induction on the length of $Q$. The case where $Q = \epsilon$ is trivial.

Case $Q = m \cdot Q''$.
\begin{enumerate}
\item[A1.] By \textsc{WF-Q1-3}, $\Sigma \vdash Q''$.
\item[A2.] By the IH, $\Sigma \vdash Q'' ::: Q'$.
\end{enumerate}

\begin{itemize}
\item Case $m = {\Res \iota v}$.
\begin{enumerate}
% 1.
\item By the assumption and \textsc{WF-Q2}
  \begin{enumerate}[label=(\alph*)]
  \item $\Sigma(\iota) = T$
  \item $\emptyset ; \Sigma \vdash v : T$
  \item $\Sigma \vdash Q''$
  \end{enumerate}
% 2.
\item By A2., 1.a-b), and \textsc{WF-Q2}, $\Sigma \vdash m \cdot Q'' ::: Q'$.
\end{enumerate}

\item Case $m = {\Req h r \iota}$.
\begin{enumerate}
% 1.
\item By the assumption and \textsc{WF-Q3}
  \begin{enumerate}[label=(\alph*)]
  \item $r = {\Ref l {h'}}$
  \item $\Sigma(id(l)) = \Sigma(\iota)$
  \item $\Sigma \vdash r$
  \item $\Sigma \vdash Q''$
  \end{enumerate}
% 2.
\item By A2., 1.a-c), and \textsc{WF-Q3}, $\Sigma \vdash m \cdot Q'' ::: Q'$.
\end{enumerate}
\end{itemize}
\end{proof}


\subsection{Proof of Theorem~\ref{th:subject-reduction}}\label{app:subject-reduction}

\begin{lem}
\emph{(Weakening)}\label{lem:weakening}
If $\Gamma ; \Sigma \vdash t : T$ and $x \notin dom(\Gamma)$, then
$\Gamma , x : T' ; \Sigma \vdash t : T$.
\end{lem}
\begin{proof}
By induction on the derivation of $\Gamma ; \Sigma \vdash t : T$.
\end{proof}

\begin{lem}
\emph{(Weakening of Store Typing)}\label{lem:weakening-store-typing}
\begin{enumerate}
\item If $\Gamma ; \Sigma \vdash t : T$ and $\iota \notin \Sigma$ then $\Gamma ; \Sigma' \vdash t : T$ where $\Sigma' = [\iota \mapsto T']\Sigma$.
\item If $\Sigma \vdash (t, \sigma, Q)^h$ and $\iota \notin \Sigma$ then $\Sigma' \vdash (t, \sigma, Q)^h$ where $\Sigma' = [\iota \mapsto T]\Sigma$.
\item If $\Sigma \vdash H$ and $\iota \notin \Sigma$ then $\Sigma' \vdash H$ where $\Sigma' = [\iota \mapsto T]\Sigma$.
\end{enumerate}
\end{lem}
\begin{proof}
Part 1: By induction on the derivation of $\Gamma ; \Sigma \vdash t : T$. Part 2: By induction on the derivation of $\Sigma \vdash (t, \sigma, Q)^h$. Part 3: By induction on the derivation of $\Sigma \vdash H$.
\end{proof}

\begin{lem}\emph{(Process)}\label{lem:process}
If $\Sigma \vdash \sigma$, $\Sigma \vdash m \cdot \emptyset$, and $process(h, m, \sigma) = (t, M, \sigma')$ then $\emptyset ; \Sigma' \vdash t : T$ for some $T$, $\Sigma' \vdash M$, and $\Sigma' \vdash \sigma'$ for some $\Sigma' \supseteq \Sigma$.
\end{lem}
\begin{proof}
\begin{itemize}
\item Case \textsc{Proc-Req}.
\begin{enumerate}
% 1.
\item By the assumptions
  \begin{enumerate}[label=(\alph*)]
  \item $\Sigma \vdash \sigma$
  \item $\Sigma \vdash m \cdot \emptyset$
  \item $process(h, m, \sigma) = (t, M, \sigma')$
  \end{enumerate}
% 2.
\item By \textsc{Proc-Req}
  \begin{enumerate}[label=(\alph*)]
  \item $m = {\Req {h'} r \iota}$
  \item $r = {\Ref l h}$
  \item $\sigma(id(l)) = (v, P)$
  \item $M = \{ h' \leftarrow {\Res \iota v} \}$
  \item $\sigma' = {\consume {id(l)} P \sigma}$
  \item $t = \texttt{unit}$
  \end{enumerate}
% 3.
\item Define $\Sigma' := \Sigma$.
% 4.
\item By 2.e) and Def.~\ref{def:consume}, $dom(\sigma') \subseteq dom(\sigma)$.
% 5.
\item By 1.a), 3., 4., and \textsc{WF-Store1-3}, $\Sigma' \vdash \sigma'$.
% 6.
\item By 1.b), 2.a,b), and \textsc{WF-Q3}
  \begin{enumerate}[label=(\alph*)]
  \item $\Sigma(id(l)) = \Sigma(\iota)$
  \item $\Sigma \vdash r$
  \end{enumerate}
% 7.
\item $T := \Sigma(id(l))$.
% 8.
\item By 1.a), 2.c), 7., and \textsc{WF-Store2}, $\emptyset ; \Sigma \vdash v : T$.
% 9.
\item By 6.a), 7., 8., \textsc{WF-Q1}, and \textsc{WF-Q2}, $\Sigma \vdash {\Res \iota v} \cdot \epsilon$.
% 10.
\item By 9. and \textsc{WF-Messages}, $\Sigma \vdash M$.
% 11.
\item By 2.f), \textsc{T-Unit}, and Lemma~\ref{lem:weakening-store-typing}, $\emptyset ; \Sigma \vdash t : T'$ for some $T'$.
% 12.
\item 3., 5., 10., and 11. close this case.
\end{enumerate}

\item Cases \textsc{Proc-ReqMat} and \textsc{Proc-ReqParent} follow analogously.

\item Case \textsc{Proc-ReqMap}.
\begin{enumerate}
% 1.
\item By the assumptions
  \begin{enumerate}[label=(\alph*)]
  \item $\Sigma \vdash \sigma$
  \item $\Sigma \vdash m \cdot \emptyset$
  \item $process(h, m, \sigma) = (t, M, \sigma')$
  \end{enumerate}
% 2.
\item By \textsc{Proc-ReqMap}
  \begin{enumerate}[label=(\alph*)]
  \item $m = {\Req {h'} r \iota}$
  \item $r = {\Ref l h}$
  \item $l = {\Mapped {\iota'} {l'} p}$
  \item $\sigma(id(l')) = (v, P)$
  \item $t = \texttt{respond}(h', \iota, p~v)$
  \item $\sigma' = {\consume {id(l')} P \sigma}$
  \item $M = \emptyset$
  \end{enumerate}
% 3.
\item By 1.b), 2.a,b), and \textsc{WF-Q3}
  \begin{enumerate}[label=(\alph*)]
  \item $\Sigma(id(l)) = \Sigma(\iota)$
  \item $\Sigma \vdash r$
  \end{enumerate}
% 4.
\item By 2.b,c), 3.b), \textsc{WF-Ref}, and \textsc{WF-Lin3}
  \begin{enumerate}[label=(\alph*)]
  \item $\Sigma(\iota') = T$
  \item $\Sigma(id(l')) = T'$
  \item $\exists \Gamma.~\Gamma ; \Sigma \vdash p : T' \Rightarrow T~\{\ldots\}$
  \item $\Sigma \vdash l'$
  \end{enumerate}
% 5.
\item By 1.a), 2.d), 4.b), and \textsc{WF-Store2}, $\emptyset ; \Sigma \vdash v : T'$.
% 6.
\item By 4.c), 5., and \textsc{T-AppSpore}, $\Gamma, \Sigma \vdash p~v : T$.
% 7.
\item By 4.c) and \textsc{T-Spore}, $serializable(T)$.
% 8.
\item By 6., 7., and Lemma~\ref{lem:ser-values}, $\emptyset ; \Sigma \vdash p~v : T$.
% 9.
\item By 3.a), 4.a), and Def.~\ref{def:id}, $\Sigma(id(l)) = \Sigma(\iota)$ and thus by \textsc{T-Ident}, $\emptyset ; \Sigma \vdash \iota : \texttt{Future}[T]$.
% 10.
\item By 8., 9., and \textsc{T-Respond}, $\emptyset ; \Sigma \vdash t : \texttt{Unit}$.
% 11.
\item By 2.g) and \textsc{WF-Messages-Emp}, $\Sigma \vdash M$.
% 12.
\item By 2.f) and Def.~\ref{def:consume}, $dom(\sigma') \subseteq dom(\sigma)$.
% 13.
\item By 1.a), 12., and \textsc{WF-Store1-3}, $\Sigma \vdash \sigma'$.
% 14.
\item 10., 11., and 13. close this case.
\end{enumerate}

\item Case \textsc{Proc-ReqFMap}.
\begin{enumerate}
% 1.
\item By the assumptions
  \begin{enumerate}[label=(\alph*)]
  \item $\Sigma \vdash \sigma$
  \item $\Sigma \vdash m \cdot \emptyset$
  \item $process(h, m, \sigma) = (t, M, \sigma')$
  \end{enumerate}
% 2.
\item By \textsc{Proc-ReqFMap}
  \begin{enumerate}[label=(\alph*)]
  \item $m = {\Req {h'} r \iota}$
  \item $r = {\Ref l h}$
  \item $l = {\FMapped {\iota'} {l'} p}$
  \item $\sigma(id(l')) = (v, P)$
  \item $t = \texttt{respond}(h', \iota, \texttt{await}(\texttt{send}(p~v)))$
  \item $\sigma' = {\consume {id(l')} P \sigma}$
  \item $M = \emptyset$
  \end{enumerate}
% 3.
\item By 1.b), 2.a,b), and \textsc{WF-Q3}
  \begin{enumerate}[label=(\alph*)]
  \item $\Sigma(id(l)) = \Sigma(\iota)$
  \item $\Sigma \vdash r$
  \end{enumerate}
% 4.
\item By 2.b,c), 3.b), \textsc{WF-Ref}, and \textsc{WF-Lin2}
  \begin{enumerate}[label=(\alph*)]
  \item $\Sigma(\iota') = T$
  \item $\Sigma(id(l')) = T'$
  \item $\exists \Gamma.~\Gamma ; \Sigma \vdash p : T' \Rightarrow \texttt{SiloRef}[T]~\{\ldots\}$
  \item $\Sigma \vdash l'$
  \end{enumerate}
% 5.
\item By 1.a), 2.d), 4.b), and \textsc{WF-Store2}, $\emptyset ; \Sigma \vdash v : T'$.
% 6.
\item By 4.c), \textsc{T-Spore}, Def.~$serializable$, and Lemma~\ref{lem:ser-values}, $\emptyset ; \Sigma \vdash p : T' \Rightarrow \texttt{SiloRef}[T]~\{\ldots\}$.
% 7.
\item By 5., 6., and \textsc{T-AppSpore}, $\emptyset, \Sigma \vdash p~v : \texttt{SiloRef}[T]$.
% 8.
\item By 7. and \textsc{T-Send}, $\emptyset, \Sigma \vdash \texttt{send}(p~v) : \texttt{Future}[T]$.
% 9.
\item By 8. and \textsc{T-Await}, $\emptyset, \Sigma \vdash \texttt{await}(\texttt{send}(p~v)) : T$.
% 10.
\item By 3.a), 4.a), and Def.~\ref{def:id}, $\Sigma(\iota) = T$ and thus by \textsc{T-Ident}, $\emptyset ; \Sigma \vdash \iota : \texttt{Future}[T]$.
% 11.
\item By 2.e), 9., 10., and \textsc{T-Respond}, $\emptyset, \Sigma \vdash t : \texttt{Unit}$.
% 12.
\item By 2.g) and \textsc{WF-Messages-Emp}, $\Sigma \vdash M$.
% 13.
\item By 2.f) and Def.~\ref{def:consume}, $dom(\sigma') \subseteq dom(\sigma)$.
% 14.
\item By 1.a), 13., and \textsc{WF-Store1-3}, $\Sigma \vdash \sigma'$.
% 15.
\item 11., 12., and 14. close this case.
\end{enumerate}

% TODO: expand for debugging
\item Cases \textsc{Proc-ReqPersist} and \textsc{Proc-Res} follow analogously.

\end{itemize}
\end{proof}


\begin{thmun}
\emph{(Subject Reduction)}

\begin{enumerate}

\item If $\Gamma ; \Sigma \vdash t : T$, $\Sigma \vdash \sigma$, and $t~|~\sigma \rightarrow^h t'~|~\sigma'$ then $\Gamma ; \Sigma' \vdash t' : T$ and $\Sigma' \vdash \sigma'$ for some $\Sigma' \supseteq \Sigma$.

\item If $\Sigma \vdash H~|~M$ and $H~|~M \twoheadrightarrow H'~|~M'$ then $\Sigma' \vdash H'~|~M'$ for some $\Sigma' \supseteq \Sigma$.

\end{enumerate}

\end{thmun}
\begin{proof}

Part 1: by induction on the derivation of $t~|~\sigma \rightarrow^h t'~|~\sigma'$ with case analysis of the last applied rule.

\begin{itemize}
\item Case \textsc{R-AppAbs}.
\begin{enumerate}
% 1.
\item By the assumptions
  \begin{enumerate}[label=(\alph*)]
  \item $\Gamma ; \Sigma \vdash t : T$
  \item $\Sigma \vdash \sigma$
  \item $t~|~\sigma \rightarrow^h t'~|~\sigma'$
  \end{enumerate}
% 2.
\item By \textsc{R-AppAbs}
  \begin{enumerate}[label=(\alph*)]
  \item $t = E[((x : T') \Rightarrow t'')~v']$
  \item $t' = E[[x \mapsto v']t'']$
  \item $\sigma' = \sigma$
  \end{enumerate}
% 3.
\item By 1.a) and 2.a), $\Gamma ; \Sigma \vdash ((x : T') \Rightarrow t'')~v' : T''$.
% 4.
\item By 3. and \textsc{T-App},
  \begin{enumerate}[label=(\alph*)]
  \item $\Gamma ; \Sigma \vdash ((x : T') \Rightarrow t'') : T' \Rightarrow T''$
  \item $\Gamma ; \Sigma \vdash v' : T'$
  \end{enumerate}
% 5.
\item By 4.a) and \textsc{T-Abs}, $\Gamma , x : T' ; \Sigma \vdash t'' : T''$.
% 6.
\item By 4.b), 5., and Lemma~\ref{th:subst}, $\Gamma ; \Sigma \vdash [x \mapsto v']t'' : T''$.
% 7.
\item By 1.a), 2.a-b), 3., and 6., $\Gamma ; \Sigma \vdash t' : T$.
% 8.
\item 2.c) and 7. close this case.
\end{enumerate}

\item Cases \textsc{R-AppSpore} and \textsc{R-Await} follow analogously.

\item Case \textsc{R-Map}.
\begin{enumerate}
% 1.
\item By the assumptions
  \begin{enumerate}[label=(\alph*)]
  \item $\Gamma ; \Sigma \vdash t : T$
  \item $\Sigma \vdash \sigma$
  \item $t~|~\sigma \rightarrow^h t'~|~\sigma'$
  \end{enumerate}
% 2.
\item By \textsc{R-Map}
  \begin{enumerate}[label=(\alph*)]
  \item $t  = E[\texttt{map}(r, p)]$
  \item $r  = {\Ref l {h'}}$
  \item $t' = E[r']$
  \item $r' = {\Ref {l'} {h'}}$
  \item $l' = {\Mapped {(h, i)} l p}$ where $i~\text{fresh}$
  \item $\sigma' = \sigma$
  \end{enumerate}
% 3.
\item By 1.a) and 2.a), $\Gamma ; \Sigma \vdash \texttt{map}(r, p) : \hat{T}$.
% 4.
\item By 3. and \textsc{T-Map},
  \begin{enumerate}[label=(\alph*)]
  \item $\hat{T} = \texttt{SiloRef}[T']$
  \item $\Gamma ; \Sigma \vdash r : \texttt{SiloRef}[T'']$
  \item $\Gamma ; \Sigma \vdash p : T'' \Rightarrow T'~\{~\texttt{type}~\mathcal{C} = \seq{T}~\}$
  \end{enumerate}
% 5.
\item By 2.b), 4.b), \textsc{T-SiloRef}, and \textsc{WF-Ref}
  \begin{enumerate}[label=(\alph*)]
  \item $\Sigma(id(l)) = T''$
  \item $\Sigma \vdash r$
  \item $\Sigma \vdash l$
  \item $h' \in \mathcal{H}$
  \end{enumerate}
% 6.
\item Define $\Sigma' := [(h, i) \mapsto T']\Sigma$.
% 7.
\item By 2.d-e), 4.c), 5.a-d), 6., \textsc{WF-Lin3}, and \textsc{WF-Ref}, $\Sigma' \vdash r'$.
% 8.
\item By 2.d-e), 6., 7., and \textsc{T-SiloRef}, $\Gamma ; \Sigma' \vdash r' : \texttt{SiloRef}[T']$.
% 9.
\item By 2.e), 3., 4.a), 6., and part 1 of Lemma~\ref{lem:weakening-store-typing}, $\Gamma ; \Sigma' \vdash \texttt{map}(r, p) : \texttt{SiloRef}[T']$.
% 10.
\item By 1.a), 2.e), 6., and part 1 of Lemma~\ref{lem:weakening-store-typing}, $\Gamma ; \Sigma' \vdash t : T$.
% 11.
\item By 2.a,c), 8., 9., 10., $\Gamma ; \Sigma' \vdash t' : T$.
% 12.
\item By 2.f) and 1.b), $\Sigma \vdash \sigma'$.
% 13.
\item By 6., $\Sigma' \supseteq \Sigma$.
% 14.
\item By 12., 13., and \textsc{WF-Store3}, $\Sigma' \vdash \sigma'$.
% 15.
\item 11., 13., and 14. close this case.
\end{enumerate}

\item Case \textsc{R-FMap}.
\begin{enumerate}
% 1.
\item By the assumptions
  \begin{enumerate}[label=(\alph*)]
  \item $\Gamma ; \Sigma \vdash t : T$
  \item $\Sigma \vdash \sigma$
  \item $t~|~\sigma \rightarrow^h t'~|~\sigma'$
  \end{enumerate}
% 2.
\item By \textsc{R-FMap}
  \begin{enumerate}[label=(\alph*)]
  \item $t  = E[\texttt{flatMap}(r, p)]$
  \item $r  = {\Ref l {h'}}$
  \item $t' = E[r']$
  \item $r' = {\Ref {l'} {h'}}$
  \item $l' = {\FMapped {(h, i)} l p}$ where $i~\text{fresh}$
  \item $\sigma' = \sigma$
  \end{enumerate}
% 3.
\item By 1.a) and 2.a), $\Gamma ; \Sigma \vdash \texttt{flatMap}(r, p) : \hat{T}$.
% 4.
\item By 3. and \textsc{T-FMap},
  \begin{enumerate}[label=(\alph*)]
  \item $\hat{T} = \texttt{SiloRef}[T']$
  \item $\Gamma ; \Sigma \vdash r : \texttt{SiloRef}[T'']$
  \item $\Gamma ; \Sigma \vdash p : T'' \Rightarrow \texttt{SiloRef}[T']~\{~\texttt{type}~\mathcal{C} = \seq{T}~\}$
  \end{enumerate}
% 5.
\item By 2.b), 4.b), \textsc{T-SiloRef}, and \textsc{WF-Ref}
  \begin{enumerate}[label=(\alph*)]
  \item $\Sigma(id(l)) = T''$
  \item $\Sigma \vdash r$
  \item $\Sigma \vdash l$
  \item $h' \in \mathcal{H}$
  \end{enumerate}
% 6.
\item Define $\Sigma' := [(h, i) \mapsto T']\Sigma$.
% 7.
\item By 2.d-e), 4.c), 5.a-d), 6., \textsc{WF-Lin2}, and \textsc{WF-Ref}, $\Sigma' \vdash r'$.
% 8.
\item By 2.d-e), 6., 7., and \textsc{T-SiloRef}, $\Gamma ; \Sigma' \vdash r' : \texttt{SiloRef}[T']$.
% 9.
\item By 2.e), 3., 4.a), 6., and part 1 of Lemma~\ref{lem:weakening-store-typing}, $\Gamma ; \Sigma' \vdash \texttt{flatMap}(r, p) : \texttt{SiloRef}[T']$.
% 10.
\item By 1.a), 2.e), 6., and part 1 of Lemma~\ref{lem:weakening-store-typing}, $\Gamma ; \Sigma' \vdash t : T$.
% 11.
\item By 2.a,c), 8., 9., and 10., $\Gamma ; \Sigma' \vdash t' : T$.
% 12.
\item By 1.b) and 2.f), $\Sigma \vdash \sigma'$.
% 13.
\item By 6., $\Sigma' \supseteq \Sigma$.
% 14.
\item By 12., 13., and \textsc{WF-Store3}, $\Sigma' \vdash \sigma'$.
% 15.
\item 11., 13., and 14. close this case.

\end{enumerate}

\item Cases \textsc{R-Persist} and \textsc{R-Unpersist} follow analogously.
\end{itemize}

%
Part 2: by induction on the derivation of $H~|~M \twoheadrightarrow H'~|~M'$ with case analysis of the last applied rule.

\begin{itemize}
\item Case \textsc{R-Local}.
\begin{enumerate}
% 1.
\item By the assumptions
  \begin{enumerate}[label=(\alph*)]
  \item $\Sigma \vdash H~|~M$
  \item $H~|~M \twoheadrightarrow H'~|~M'$
  \end{enumerate}
% 2.
\item By \textsc{R-Local}
  \begin{enumerate}[label=(\alph*)]
  \item $H = \{ (t, \sigma, Q)^h \} \cup H''$
  \item $H' = \{ (t', \sigma', Q)^h \} \cup H''$
  \item $t~|~\sigma \rightarrow^h t'~|~\sigma'$
  \item $M' = M$
  \end{enumerate}
% 3.
\item By 1.a) and \textsc{WF-Config}, $\Sigma \vdash H$.
% 4.
\item By 2.a), 3., and \textsc{WF-Host2}
  \begin{enumerate}[label=(\alph*)]
  \item $\Sigma \vdash (t, \sigma, Q)^h$
  \item $\Sigma \vdash H''$
  \end{enumerate}
% 5.
\item By 4.a) and \textsc{WF-HostConfig}
  \begin{enumerate}[label=(\alph*)]
  \item $\Sigma \vdash \sigma$
  \item $\Sigma \vdash Q$
  \item $\Gamma ; \Sigma \vdash t : T$
  \end{enumerate}
% 6.
\item By 2.c), 5.a,c), and part 1
  \begin{enumerate}[label=(\alph*)]
  \item $\Gamma ; \Sigma' \vdash t' : T$
  \item $\Sigma' \vdash \sigma'$ for some $\Sigma' \supseteq \Sigma$
  \end{enumerate}
% 7.
\item By 5.b), 6.b), and \textsc{WF-Q1-3}, $\Sigma' \vdash Q$.
% 8.
\item By 6.a-b), 7., and \textsc{WF-HostConfig}, $\Sigma' \vdash (t', \sigma', Q)^h$.
% 9.
\item By 4.b) and part 3 of Lemma~\ref{lem:weakening-store-typing}, $\Sigma' \vdash H''$.
% 10.
\item By 2.b), 8., 9., and \textsc{WF-Host2}, $\Sigma' \vdash H'$.
% 11.
\item By 1.a), 2.d), 10., \textsc{WF-Config}, \textsc{WF-Messages}, and \textsc{WF-Q1-3}, $\Sigma' \vdash H'~|~M'$.
\end{enumerate}

\item Case \textsc{R-Send}.
\begin{enumerate}
% 1.
\item By the assumptions
  \begin{enumerate}[label=(\alph*)]
  \item $\Sigma \vdash H~|~M$
  \item $H~|~M \twoheadrightarrow H'~|~M'$
  \end{enumerate}
% 2.
\item By \textsc{R-Send}
  \begin{enumerate}[label=(\alph*)]
  \item $H  = \{ (E[\texttt{send}(r)], \sigma, Q)^h \} \cup H''$
  \item $H' = \{ (E[id(l)], \sigma, Q)^h \} \cup H''$
  \item $r  = {\Ref l {h'}}$
  \item $m  = {\Req h r {id(l)}}$
  \item $M' = M \cup \{ h' \leftarrow m \}$
  \end{enumerate}
% 3.
\item By 1.a) and \textsc{WF-Config}
  \begin{enumerate}[label=(\alph*)]
  \item $\Sigma \vdash H$
  \item $\Sigma \vdash M$
  \end{enumerate}
% 4.
\item By 2.a), 3.a), and \textsc{WF-Host2}
  \begin{enumerate}[label=(\alph*)]
  \item $\Sigma \vdash (E[\texttt{send}(r)], \sigma, Q)^h$
  \item $\Sigma \vdash H''$
  \end{enumerate}
% 5.
\item By 4.a) and \textsc{WF-HostConfig}
  \begin{enumerate}[label=(\alph*)]
  \item $\Sigma \vdash \sigma$
  \item $\Sigma \vdash Q$
  \item $\Gamma ; \Sigma \vdash E[\texttt{send}(r)] : T$
  \end{enumerate}
% 6.
\item By 5.c), $\Gamma ; \Sigma \vdash \texttt{send}(r) : \hat{T}$.
% 7.
\item By 6. and \textsc{T-Send}
  \begin{enumerate}[label=(\alph*)]
  \item $\hat{T} = \texttt{Future}[T'']$
  \item $\Gamma ; \Sigma \vdash r : \texttt{SiloRef}[T'']$
  \end{enumerate}
% 8.
\item By 2.c), 7.b), and \textsc{T-SiloRef}
  \begin{enumerate}[label=(\alph*)]
  \item $\Sigma(id(l)) = T''$
  \item $\Sigma \vdash r$
  \end{enumerate}
% 9.
\item By 8.a) and \textsc{T-Ident}, $\Gamma ; \Sigma \vdash id(l) : \texttt{Future}[T'']$.
% 10.
\item By 5.c), 6., 7.a), and 9., $\Gamma ; \Sigma \vdash E[id(l)] : T$.
% 11.
\item By 5.a,b), 10., and \textsc{WF-HostConfig}, $\Sigma \vdash (E[id(l)], \sigma, Q)^h$.
% 12.
\item By 4.b), 11., and \textsc{WF-Host2}, $\Sigma \vdash H'$.
% 13.
\item By 2.c-d), 8.a,b), and \textsc{WF-Q1-3}, $\Sigma \vdash m \cdot \epsilon$.
% 14.
\item By 2.e), 3.b), 13., and \textsc{WF-Messages}, $\Sigma \vdash M'$.
% 15.
\item By 12., 14., and \textsc{WF-Config}, $\Sigma \vdash H'~|~M'$.
\end{enumerate}

\item Cases \textsc{R-Populate} and \textsc{R-Respond} follow analogously.

\item Case \textsc{R-Process}.
\begin{enumerate}
% 1.
\item By the assumptions
  \begin{enumerate}[label=(\alph*)]
  \item $\Sigma \vdash H~|~M$
  \item $H~|~M \twoheadrightarrow H'~|~M'$
  \end{enumerate}
% 2.
\item By \textsc{R-Process}
  \begin{enumerate}[label=(\alph*)]
  \item $H  = \{ (E[\texttt{await}(\iota)], \sigma, m \cdot Q)^h \} \cup H''$
  \item $H' = \{ (E[t~;~\texttt{await}(\iota)], \sigma', Q)^h \} \cup H''$
  \item $M' = M \cup M''$
  \item $process(h, m, \sigma) = (t, M'', \sigma')$
  \end{enumerate}
% 3.
\item By 1.a) and \textsc{WF-Config}
  \begin{enumerate}[label=(\alph*)]
  \item $\Sigma \vdash H$
  \item $\Sigma \vdash M$
  \end{enumerate}
% 4.
\item By 2.a), 3.a), and \textsc{WF-Host2}
  \begin{enumerate}[label=(\alph*)]
  \item $\Sigma \vdash (E[\texttt{await}(\iota)], \sigma, m \cdot Q)^h$
  \item $\Sigma \vdash H''$
  \end{enumerate}
% 5.
\item By 4.a) and \textsc{WF-HostConfig}
  \begin{enumerate}[label=(\alph*)]
  \item $\Sigma \vdash \sigma$
  \item $\Sigma \vdash m \cdot Q$
  \item $\Gamma ; \Sigma \vdash E[\texttt{await}(\iota)] : T$
  \end{enumerate}
% 6.
\item By 5.b) and \textsc{WF-Q1-3}
  \begin{enumerate}[label=(\alph*)]
  \item $\Sigma \vdash Q$
  \item $\Sigma \vdash m \cdot \epsilon$
  \end{enumerate}
% 7.
\item By 2.d), 5.a), 6.b), and Lemma~\ref{lem:process}
  \begin{enumerate}[label=(\alph*)]
  \item $\emptyset ; \Sigma' \vdash t : T'$
  \item $\Sigma' \vdash M''$
  \item $\Sigma' \vdash \sigma'$
  \item $\Sigma' \supseteq \Sigma$
  \end{enumerate}
% 8.
\item By 5.c), 7.d), and part 1 of Lemma~\ref{lem:weakening-store-typing}, $\Gamma ; \Sigma' \vdash E[\texttt{await}(\iota)] : T$.
% 9. XXX
\item By 7.a) and 8., $\Gamma ; \Sigma' \vdash E[t~;~\texttt{await}(\iota)] : T$.
% 10.
\item By 6.a), 7.d), and \textsc{WF-Q1-3}, $\Sigma' \vdash Q$.
% 11.
\item 7.c), 9., 10., and \textsc{WF-HostConfig}, $\Sigma' \vdash (E[t~;~\texttt{await}(\iota)], \sigma', Q)^h$.
% 12.
\item By 4.b), 7.d), and part 3 of Lemma~\ref{lem:weakening-store-typing}, $\Sigma' \vdash H''$.
% 13.
\item By 2.b), 11., 12., and \textsc{WF-Host2}, $\Sigma' \vdash H'$.
% 14.
\item By 3.b), 7.d), \textsc{WF-Messages}, and \textsc{WF-Q1-3}, $\Sigma' \vdash M$.
% 15.
\item By 2.c), 7.b), 14., and \textsc{WF-Messages}, $\Sigma' \vdash M'$.
% 16.
\item By 13., 15., and \textsc{WF-Config}, $\Sigma' \vdash H'~|~M'$.
\end{enumerate}

\item Case \textsc{R-Process-Val} follows analogously.

\end{itemize}

\end{proof}
